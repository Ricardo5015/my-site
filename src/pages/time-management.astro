---
import MainGridLayout from '@layouts/MainGridLayout.astro';
---

<MainGridLayout title="æ—¶é—´ç®¡ç†" description="ä¸‰å¤©æ‰“é±¼ä¸¤å¤©æ™’ç½‘æ³•">
  <div id="time-management-root"></div>
</MainGridLayout>

<script>
  import React from 'react';
  import { createRoot } from 'react-dom/client';
  
  // å°†ä¸Šé¢ artifact ä¸­çš„ç»„ä»¶ä»£ç å¤åˆ¶åˆ°è¿™é‡Œ
  const TimeManagementCalendar = () => {
    import React, { useState, useEffect } from 'react';
import { Calendar, Target, Sparkles, RotateCcw, Coffee } from 'lucide-react';

const TimeManagementCalendar = () => {
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const [themes, setThemes] = useState([
    { name: 'èŒä¸šå‘å±•', color: 'from-blue-500 to-blue-600', icon: 'ğŸ’¼', borderColor: 'border-blue-400' },
    { name: 'å…´è¶£çˆ±å¥½', color: 'from-purple-500 to-purple-600', icon: 'ğŸ¨', borderColor: 'border-purple-400' },
    { name: 'èº«å¿ƒå¥åº·', color: 'from-green-500 to-green-600', icon: 'ğŸ’ª', borderColor: 'border-green-400' }
  ]);
  const [calendarDays, setCalendarDays] = useState([]);
  const [stats, setStats] = useState({ work: 0, rest: 0, total: 0 });
  const [draggedCard, setDraggedCard] = useState(null);
  const [draggedCardType, setDraggedCardType] = useState(null); // 'work' or 'rest'
  const [availableWorkCards, setAvailableWorkCards] = useState(7);
  const [availableRestCards, setAvailableRestCards] = useState(3);
  const [usedWorkCards, setUsedWorkCards] = useState(0);
  const [usedRestCards, setUsedRestCards] = useState(0);
  const [showCelebration, setShowCelebration] = useState(false);

  useEffect(() => {
    generateCalendar();
  }, [currentMonth]);

  const generateCalendar = () => {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startWeekday = firstDay.getDay();

    const days = [];
    for (let i = 0; i < startWeekday; i++) {
      days.push({ date: null, type: null, themes: [], cardId: null });
    }

    for (let date = 1; date <= daysInMonth; date++) {
      days.push({ date, type: null, themes: [], cardId: null });
    }

    setCalendarDays(days);
    updateStats(days);
  };

  const updateStats = (days) => {
    const workDays = days.filter(d => d.date && d.type === 'work').length;
    const restDays = days.filter(d => d.date && d.type === 'rest').length;
    const total = days.filter(d => d.date).length;
    
    const workCardsUsed = new Set(days.filter(d => d.cardId !== null && d.type === 'work').map(d => d.cardId)).size;
    const restCardsUsed = new Set(days.filter(d => d.cardId !== null && d.type === 'rest').map(d => d.cardId)).size;
    
    setUsedWorkCards(workCardsUsed);
    setUsedRestCards(restCardsUsed);
    
    setStats({ work: workDays, rest: restDays, total });
  };

  const changeMonth = (direction) => {
    const newDate = new Date(currentMonth);
    newDate.setMonth(newDate.getMonth() + direction);
    setCurrentMonth(newDate);
  };

  const handleDragStart = (e, cardIndex, cardType) => {
    setDraggedCard(cardIndex);
    setDraggedCardType(cardType);
    e.dataTransfer.effectAllowed = 'copy';
  };

  const handleDragOver = (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
  };

  const handleDrop = (e, startIndex) => {
    e.preventDefault();
    
    if (draggedCard === null || draggedCardType === null) return;
    
    const day = calendarDays[startIndex];
    if (!day.date) return;

    const newDays = [...calendarDays];
    const cardId = Date.now();
    const cardLength = draggedCardType === 'work' ? 3 : 2;
    
    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å¯ç”¨å¡ç‰‡
    if (draggedCardType === 'work' && usedWorkCards >= availableWorkCards) {
      alert('åŠªåŠ›ç”Ÿæ´»å¡å·²ç»ç”¨å®Œå•¦ï¼ğŸ´');
      resetDrag();
      return;
    }
    if (draggedCardType === 'rest' && usedRestCards >= availableRestCards) {
      alert('æ— æ•Œæ‘†çƒ‚å¡å·²ç»ç”¨å®Œå•¦ï¼ğŸ˜´');
      resetDrag();
      return;
    }
    
    // æ£€æŸ¥æ˜¯å¦èƒ½æ”¾ç½®è¿ç»­çš„å¤©æ•°
    let canPlace = true;
    for (let i = 0; i < cardLength; i++) {
      const targetIndex = startIndex + i;
      if (targetIndex >= newDays.length || !newDays[targetIndex].date) {
        canPlace = false;
        break;
      }
      // æ£€æŸ¥æ˜¯å¦è·¨å‘¨ï¼ˆå‘¨æ—¥æ˜¯0ï¼‰
      const currentWeekDay = (startIndex + i) % 7;
      if (i > 0 && currentWeekDay === 0) {
        canPlace = false;
        break;
      }
    }

    if (!canPlace) {
      alert(`è¿™é‡Œæ”¾ä¸ä¸‹å®Œæ•´çš„${cardLength}å¤©å¡ç‰‡å“¦ï¼è¯·é€‰æ‹©å…¶ä»–ä½ç½® ğŸ—“ï¸`);
      resetDrag();
      return;
    }

    // æ”¾ç½®å¡ç‰‡
    if (draggedCardType === 'work') {
      for (let i = 0; i < 3; i++) {
        const targetIndex = startIndex + i;
        newDays[targetIndex].themes = [i];
        newDays[targetIndex].cardId = cardId;
        newDays[targetIndex].type = 'work';
      }
    } else {
      for (let i = 0; i < 2; i++) {
        const targetIndex = startIndex + i;
        newDays[targetIndex].themes = [];
        newDays[targetIndex].cardId = cardId;
        newDays[targetIndex].type = 'rest';
      }
    }

    setCalendarDays(newDays);
    updateStats(newDays);
    resetDrag();
    
    // æ˜¾ç¤ºåº†ç¥åŠ¨ç”»
    setShowCelebration(true);
    setTimeout(() => setShowCelebration(false), 1500);
  };

  const resetDrag = () => {
    setDraggedCard(null);
    setDraggedCardType(null);
  };

  const removeCard = (cardId) => {
    const newDays = calendarDays.map(day => {
      if (day.cardId === cardId) {
        return { ...day, themes: [], cardId: null, type: null };
      }
      return day;
    });
    
    setCalendarDays(newDays);
    updateStats(newDays);
  };

  const resetCalendar = () => {
    if (confirm('ç¡®å®šè¦é‡ç½®æœ¬æœˆçš„æ‰€æœ‰å®‰æ’å—ï¼Ÿ')) {
      generateCalendar();
    }
  };

  const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

  // è·å–æ‰€æœ‰å”¯ä¸€çš„cardId
  const usedWorkCardIds = [...new Set(calendarDays.filter(d => d.cardId !== null && d.type === 'work').map(d => d.cardId))];
  const usedRestCardIds = [...new Set(calendarDays.filter(d => d.cardId !== null && d.type === 'rest').map(d => d.cardId))];

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4 md:p-8">
      <div className="max-w-7xl mx-auto">
        {/* æ ‡é¢˜ */}
        <div className="text-center mb-8">
          <h1 className="text-4xl md:text-5xl font-bold text-white mb-3 flex items-center justify-center gap-3">
            <Sparkles className="w-8 h-8 text-yellow-300 animate-pulse" />
            ä¸‰å¤©æ‰“é±¼ï¼Œä¸¤å¤©æ™’ç½‘
            <Sparkles className="w-8 h-8 text-yellow-300 animate-pulse" />
          </h1>
          <p className="text-gray-300 text-lg">æ‹–æ‹½å¡ç‰‡æ¥è§„åˆ’ä½ çš„åŠªåŠ›ç”Ÿæ´» ğŸ´</p>
        </div>

        {/* ç»Ÿè®¡ä¿¡æ¯ */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div className="bg-gradient-to-br from-blue-500/20 to-purple-500/20 backdrop-blur-lg rounded-xl p-4 border border-blue-400/30">
            <div className="text-blue-300 text-sm mb-1">åŠªåŠ›å¡ç‰‡</div>
            <div className="text-2xl font-bold text-white">{usedWorkCards} / {availableWorkCards}</div>
          </div>
          <div className="bg-gradient-to-br from-pink-500/20 to-rose-500/20 backdrop-blur-lg rounded-xl p-4 border border-pink-400/30">
            <div className="text-pink-300 text-sm mb-1">æ‘†çƒ‚å¡ç‰‡</div>
            <div className="text-2xl font-bold text-white">{usedRestCards} / {availableRestCards}</div>
          </div>
          <div className="bg-gradient-to-br from-green-500/20 to-emerald-500/20 backdrop-blur-lg rounded-xl p-4 border border-green-400/30">
            <div className="text-green-300 text-sm mb-1">åŠªåŠ›å¤©æ•°</div>
            <div className="text-2xl font-bold text-white">{stats.work} å¤©</div>
          </div>
          <div className="bg-gradient-to-br from-purple-500/20 to-indigo-500/20 backdrop-blur-lg rounded-xl p-4 border border-purple-400/30">
            <div className="text-purple-300 text-sm mb-1">å®Œæˆç‡</div>
            <div className="text-2xl font-bold text-white">
              {stats.total > 0 ? Math.round((stats.work / stats.total) * 100) : 0}%
            </div>
          </div>
        </div>

        {/* æ—¥å†ä¸»ä½“ */}
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-4 md:p-8 border border-white/20 mb-6">
          {/* æœˆä»½åˆ‡æ¢ */}
          <div className="flex items-center justify-between mb-6">
            <button
              onClick={() => changeMonth(-1)}
              className="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white transition-all font-medium"
            >
              â† ä¸Šæœˆ
            </button>
            <div className="text-center">
              <h2 className="text-3xl font-bold text-white mb-1">
                {currentMonth.getFullYear()} å¹´ {currentMonth.getMonth() + 1} æœˆ
              </h2>
              <button
                onClick={resetCalendar}
                className="text-xs bg-red-500/20 hover:bg-red-500/30 px-3 py-1 rounded-lg transition-all flex items-center gap-1 mx-auto text-white"
              >
                <RotateCcw className="w-3 h-3" />
                é‡ç½®
              </button>
            </div>
            <button
              onClick={() => changeMonth(1)}
              className="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white transition-all font-medium"
            >
              ä¸‹æœˆ â†’
            </button>
          </div>

          {/* æ˜ŸæœŸæ ‡é¢˜ */}
          <div className="grid grid-cols-7 gap-2 md:gap-3 mb-3">
            {weekDays.map(day => (
              <div key={day} className="text-center text-gray-300 font-bold py-2 text-sm md:text-lg">
                {day}
              </div>
            ))}
          </div>

          {/* æ—¥æœŸæ ¼å­ */}
          <div className="grid grid-cols-7 gap-2 md:gap-3">
            {calendarDays.map((day, index) => {
              const hasCard = day.cardId !== null;
              const themeIndex = day.themes[0];
              const isWorkDay = day.type === 'work';
              const isRestDay = day.type === 'rest';
              
              return (
                <div
                  key={index}
                  onDragOver={handleDragOver}
                  onDrop={(e) => handleDrop(e, index)}
                  className={`
                    aspect-square rounded-xl flex flex-col items-center justify-center
                    transition-all duration-300 relative group
                    ${!day.date ? 'invisible' : ''}
                    ${isWorkDay && themeIndex !== undefined
                      ? `bg-gradient-to-br ${themes[themeIndex].color} shadow-xl border-2 ${themes[themeIndex].borderColor}`
                      : isRestDay
                      ? 'bg-gradient-to-br from-pink-400 to-rose-500 shadow-xl border-2 border-pink-300'
                      : 'bg-white/5 border-2 border-dashed border-white/20 hover:border-white/50 hover:bg-white/10'
                    }
                  `}
                >
                  {day.date && (
                    <>
                      <span className={`font-bold text-lg md:text-xl ${hasCard ? 'text-white' : 'text-gray-400'}`}>
                        {day.date}
                      </span>
                      {isWorkDay && themeIndex !== undefined && (
                        <div className="mt-1 flex flex-col items-center">
                          <span className="text-xl md:text-3xl">{themes[themeIndex].icon}</span>
                          <span className="text-[10px] md:text-xs text-white/90 mt-1 font-medium">
                            {themes[themeIndex].name}
                          </span>
                        </div>
                      )}
                      {isRestDay && (
                        <div className="mt-1 flex flex-col items-center">
                          <span className="text-xl md:text-3xl">ğŸ˜´</span>
                          <span className="text-[10px] md:text-xs text-white/90 mt-1 font-medium">
                            æ‘†çƒ‚æ—¥
                          </span>
                        </div>
                      )}
                      {!hasCard && draggedCard !== null && (
                        <div className="absolute inset-0 flex items-center justify-center bg-blue-500/20 rounded-xl backdrop-blur-sm">
                          <span className="text-white text-xs font-medium">æ”¾è¿™é‡Œ</span>
                        </div>
                      )}
                    </>
                  )}
                </div>
              );
            })}
          </div>
        </div>

        {/* å¡ç‰‡åŒºåŸŸ */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          {/* åŠªåŠ›ç”Ÿæ´»å¡ */}
          <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
            <div className="text-white font-bold mb-4 flex items-center gap-2 text-lg">
              ğŸ´ åŠªåŠ›ç”Ÿæ´»å¡
            </div>
            
            <div className="grid grid-cols-2 gap-3">
              {[...Array(availableWorkCards)].map((_, index) => {
                const isUsed = index < usedWorkCards;
                return (
                  <div
                    key={index}
                    draggable={!isUsed}
                    onDragStart={(e) => !isUsed && handleDragStart(e, index, 'work')}
                    className={`
                      relative group
                      ${isUsed ? 'opacity-30 cursor-not-allowed' : 'cursor-grab active:cursor-grabbing'}
                    `}
                  >
                    <div className={`
                      bg-gradient-to-br from-amber-400 via-orange-500 to-red-500
                      rounded-lg p-3 border-2 border-amber-300
                      shadow-lg transition-all duration-300
                      ${!isUsed ? 'hover:scale-105 hover:shadow-2xl' : ''}
                    `}>
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-white font-bold text-sm">#{index + 1}</span>
                        {isUsed && <span className="text-[10px] bg-black/30 px-2 py-0.5 rounded">å·²ç”¨</span>}
                      </div>
                      
                      <div className="space-y-1">
                        {themes.map((theme, i) => (
                          <div key={i} className="flex items-center gap-1 bg-white/20 rounded px-2 py-1 backdrop-blur-sm">
                            <span className="text-sm">{theme.icon}</span>
                            <span className="text-white text-[10px]">{theme.name}</span>
                          </div>
                        ))}
                      </div>

                      {!isUsed && (
                        <div className="mt-2 text-center text-white/90 text-[10px] font-medium bg-black/20 rounded py-1">
                          æ‹–æ‹½ä½¿ç”¨
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>

            {/* å·²ä½¿ç”¨çš„åŠªåŠ›å¡ */}
            {usedWorkCardIds.length > 0 && (
              <div className="mt-4 pt-4 border-t border-white/10">
                <div className="text-white text-sm mb-2">å·²ä½¿ç”¨ï¼š</div>
                <div className="flex flex-wrap gap-2">
                  {usedWorkCardIds.map((cardId, index) => (
                    <button
                      key={cardId}
                      onClick={() => removeCard(cardId)}
                      className="bg-red-500/20 hover:bg-red-500/30 border border-red-400/50 px-2 py-1 rounded text-white text-xs transition-all"
                    >
                      #{index + 1} Ã—
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* æ— æ•Œæ‘†çƒ‚å¡ */}
          <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
            <div className="text-white font-bold mb-4 flex items-center gap-2 text-lg">
              ğŸ˜´ æ— æ•Œæ‘†çƒ‚å¡
            </div>
            
            <div className="grid grid-cols-2 gap-3">
              {[...Array(availableRestCards)].map((_, index) => {
                const isUsed = index < usedRestCards;
                return (
                  <div
                    key={index}
                    draggable={!isUsed}
                    onDragStart={(e) => !isUsed && handleDragStart(e, index, 'rest')}
                    className={`
                      relative group
                      ${isUsed ? 'opacity-30 cursor-not-allowed' : 'cursor-grab active:cursor-grabbing'}
                    `}
                  >
                    <div className={`
                      bg-gradient-to-br from-pink-400 via-rose-400 to-red-400
                      rounded-lg p-4 border-2 border-pink-300
                      shadow-lg transition-all duration-300
                      ${!isUsed ? 'hover:scale-105 hover:shadow-2xl' : ''}
                    `}>
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-white font-bold text-sm">#{index + 1}</span>
                        {isUsed && <span className="text-[10px] bg-black/30 px-2 py-0.5 rounded">å·²ç”¨</span>}
                      </div>
                      
                      <div className="text-center space-y-2">
                        <div className="text-4xl">ğŸ˜´</div>
                        <div className="text-white text-xs font-medium">è¿ç»­æ‘†çƒ‚ 2 å¤©</div>
                      </div>

                      {!isUsed && (
                        <div className="mt-2 text-center text-white/90 text-[10px] font-medium bg-black/20 rounded py-1">
                          æ‹–æ‹½ä½¿ç”¨
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>

            {/* å·²ä½¿ç”¨çš„æ‘†çƒ‚å¡ */}
            {usedRestCardIds.length > 0 && (
              <div className="mt-4 pt-4 border-t border-white/10">
                <div className="text-white text-sm mb-2">å·²ä½¿ç”¨ï¼š</div>
                <div className="flex flex-wrap gap-2">
                  {usedRestCardIds.map((cardId, index) => (
                    <button
                      key={cardId}
                      onClick={() => removeCard(cardId)}
                      className="bg-red-500/20 hover:bg-red-500/30 border border-red-400/50 px-2 py-1 rounded text-white text-xs transition-all"
                    >
                      #{index + 1} Ã—
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>

        {/* ä½¿ç”¨è¯´æ˜ */}
        <div className="bg-gradient-to-r from-yellow-500/10 to-orange-500/10 backdrop-blur-lg rounded-xl p-4 border border-yellow-500/30">
          <div className="text-yellow-300 font-semibold mb-2 flex items-center gap-2">
            ğŸ’¡ ä½¿ç”¨è¯´æ˜
          </div>
          <ul className="text-yellow-200 text-sm space-y-1">
            <li>â€¢ ğŸ´ <strong>åŠªåŠ›ç”Ÿæ´»å¡</strong>ï¼šæ‹–æ‹½åˆ°æ—¥å†ï¼Œå æ®è¿ç»­3å¤©ï¼Œæ¯å¤©ä¸€ä¸ªä¸»é¢˜</li>
            <li>â€¢ ğŸ˜´ <strong>æ— æ•Œæ‘†çƒ‚å¡</strong>ï¼šæ‹–æ‹½åˆ°æ—¥å†ï¼Œå æ®è¿ç»­2å¤©ï¼Œå®‰å¿ƒä¼‘æ¯</li>
            <li>â€¢ ğŸ—‘ï¸ ç‚¹å‡»ä¸‹æ–¹"å·²ä½¿ç”¨"åŒºåŸŸçš„å¡ç‰‡ç¼–å·å¯ä»¥ç§»é™¤</li>
            <li>â€¢ ğŸ“Š å»ºè®®é…ç½®ï¼š7å¼ åŠªåŠ›å¡(21å¤©) + 3å¼ æ‘†çƒ‚å¡(6å¤©) = çº¦60%åŠªåŠ›ç‡</li>
            <li>â€¢ âœ¨ è®°ä½ï¼šä¸‰å¤©æ‰“é±¼ä¸¤å¤©æ™’ç½‘ï¼Œä¹Ÿæ˜¯ä¸€ç§åšæŒï¼</li>
          </ul>
        </div>

        {/* åº†ç¥åŠ¨ç”» */}
        {showCelebration && (
          <div className="fixed inset-0 flex items-center justify-center pointer-events-none z-50">
            <div className="text-8xl animate-bounce">
              {draggedCardType === 'work' ? 'ğŸ‰' : 'ğŸ˜´'}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default TimeManagementCalendar;
  };

  const container = document.getElementById('time-management-root');
  if (container) {
    const root = createRoot(container);
    root.render(React.createElement(TimeManagementCalendar));
  }
</script>